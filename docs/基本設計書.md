# AI司令塔ナレッジ - 基本設計書 (v3.0)

## 1. システム概要

### 1.1 システム名
**AI司令塔ナレッジ**（進化版：自動更新機能付き）

### 1.2 目的
開発現場で「困った！」と思った時に、AIへの最適なプロンプトを即座に発行できるナレッジベース。さらに、世界中の最新AIトレンドを自動で収集し、それを「実務で使える戦術」に変換して毎日更新する仕組み。

### 1.3 コンセプト
- **毎日自動で進化するナレッジ**: 静的なメモではなく、寝ている間に最新情報が追加される「生きたナレッジベース」
- **AIが自動で情報収集**: 情報収集から分析まで、AIエージェントが自律的に実行
- **寝ている間に資産が増える**: 朝起きたら新しい戦術が追加されている仕組み
- **経験則とAI提案の分離**: ユーザーの経験則（✍️）とAI生成（🤖）を明確に区別

---

## 2. システム構成

### 2.1 ファイル構成

```
ai-code/
├── app.py                  # メインアプリ（画面表示・Streamlit）
├── styles.py               # デザイン設定（カスタムCSS）
├── data/
│   ├── situations.json     # 経験則データ（ユーザーの知見・手動管理）
│   └── ai_tactics.json     # AI生成戦術（自動更新される）
├── scripts/                # 自動化スクリプト
│   ├── collector.py        # ニュース収集スクリプト（Gemini API）
│   ├── analyst.py          # 戦術分析スクリプト（Gemini API）
│   └── merge_tactics.py    # 戦術マージスクリプト
├── .github/
│   └── workflows/
│       └── daily_intel.yml # 毎日自動実行の設定（GitHub Actions）
├── docs/
│   └── 基本設計書.md        # 本ドキュメント
├── news_raw.json           # 収集したニュース（一時ファイル）
├── new_tactics.json        # 生成した戦術（一時ファイル）
├── requirements.txt        # 必要なライブラリ一覧
├── vercel.json             # Vercel設定（無効化）
└── README.md               # プロジェクト説明
```

### 2.2 使っている技術

| 役割 | 技術 | 説明 |
|------|------|------|
| 画面表示 | Streamlit | Pythonで簡単にWebアプリを作れるフレームワーク |
| ホスティング | Streamlit Cloud | Streamlitアプリの無料ホスティング |
| デザイン | カスタムCSS | モダンでかっこいい見た目にする |
| プログラミング言語 | Python 3.11 | メインの開発言語 |
| ニュース収集 | Google Gemini API | 最新のAIニュースを検索・要約（Google Search Grounding機能付き） |
| 戦術分析 | Google Gemini API | ニュースを「実務で使える戦術」に変換 |
| 自動実行 | GitHub Actions | 毎日決まった時間に自動でスクリプトを実行 |
| データ保存 | JSONファイル | ナレッジデータをファイルで管理 |

---

## 3. 機能一覧

### 3.1 システム全体の流れ

```
┌─────────────────────────────────────────────────────────────────┐
│                  AI司令塔ナレッジ（自動更新版）                     │
├──────────────┬──────────────────────────────┬───────────────────┤
│   ニュース収集  │         戦術分析              │      画面表示      │
│  collector.py │       analyst.py             │      app.py       │
│   (自動実行)   │        (自動実行)             │    (ユーザー)      │
├──────────────┼──────────────────────────────┼───────────────────┤
│ ・最新AIニュース│ ・実務で使えるかどうか判断      │ ・ナレッジ検索      │
│   を探す       │ ・プロンプトを作成             │ ・ソースフィルター   │
│ ・Markdown解析 │ ・推奨AIモデルを選ぶ           │ ・推奨AI表示       │
│ ・URL解決      │ ・タイムスタンプID生成          │ ・プロンプト発行    │
└──────┬───────┴──────────────┬───────────────┴─────────┬─────────┘
       │                      │                         │
       ▼                      ▼                         │
 [news_raw.json]      [new_tactics.json]                │
       │                      │                         │
       └──────────────────────┼─────────────────────────┘
                              ▼
                    [merge_tactics.py]
                              │
          ┌───────────────────┴───────────────────┐
          ▼                                       ▼
  [data/situations.json]              [data/ai_tactics.json]
    ✍️ 経験則（手動管理）                🤖 AI生成（自動更新）
```

### 3.2 各機能の詳細

#### 機能1: 自動ニュース収集（毎朝6時に実行）

| 項目 | 内容 |
|------|------|
| 機能名 | 自動ニュース収集 |
| スクリプト | `scripts/collector.py` |
| いつ動く | 毎日朝6時（日本時間）/ 手動実行も可能 |
| 何をする | Google Gemini API（Google Search Grounding機能付き）を使って、最新の「エンジニアに役立つAIニュース」を5件集める |
| 使うモデル | `gemini-2.5-flash-lite`（軽量版・クォータに余裕あり） |
| 入力 | プロンプト（対象読者、収集条件、出力形式を指定） |
| 出力 | `news_raw.json`（タイトル、要約、URL、収集日時） |
| エラー時 | 3回までリトライ、失敗してもログに記録して次回も実行を続ける |

#### 機能2: 戦術分析・生成（ニュース収集の後、自動実行）

| 項目 | 内容 |
|------|------|
| 機能名 | 戦術分析・生成 |
| スクリプト | `scripts/analyst.py` |
| 何をする | 集めたニュースを見て、「これをエンジニアの実務でどう使えるか？」を考え、すぐ使えるプロンプトと推奨AIモデルを作成する |
| 使うモデル | `gemini-2.5-flash`（高性能版） |
| 入力 | `news_raw.json` |
| 出力 | `new_tactics.json`（戦術データ） |
| ID形式 | タイムスタンプベース `20251208_150418_01`（重複防止） |

#### 機能3: 戦術マージ

| 項目 | 内容 |
|------|------|
| 機能名 | 戦術マージ |
| スクリプト | `scripts/merge_tactics.py` |
| 何をする | 新しい戦術を`ai_tactics.json`にマージ（IDで重複チェック） |
| 保存先 | `data/ai_tactics.json`（**situations.jsonは変更しない**） |
| 最大件数 | 500件（超過時は古いものを削除） |

#### 機能4: キーワード検索（画面で使える）

| 項目 | 内容 |
|------|------|
| 機能名 | キーワード検索 |
| 何をする | 入力したキーワードでナレッジを絞り込む |
| 検索対象 | タイトル、problem_context、プロンプト、タグ |
| 検索方法 | 部分一致（大文字小文字は区別しない） |

#### 機能5: ソースフィルター（画面で使える）

| 項目 | 内容 |
|------|------|
| 機能名 | ソースフィルター |
| 何をする | 経験則のみ / AI提案のみ / すべて を切り替える |
| 選択肢 | 「すべて」「✍️ 経験則のみ」「🤖 AI提案のみ」 |

#### 機能6: プロンプト発行（画面で使える）

| 項目 | 内容 |
|------|------|
| 機能名 | プロンプト発行 |
| 何をする | 設定した変数を埋め込んだ完成形プロンプトを作成・表示する |
| 表示形式 | Markdown形式のコードブロック（コピーしてすぐ使える） |

#### 機能7: 推奨AI表示（画面で使える）

| 項目 | 内容 |
|------|------|
| 機能名 | 推奨AI表示 |
| 何をする | 各ナレッジカードに「🚀 推奨: [モデル名]」というバッジと、その選定理由を表示する |
| NEWマーク | 作成日が3日以内のデータには「🔥 NEW」アイコンを付ける |
| ソースバッジ | ✍️（経験則）または 🤖（AI生成）を表示 |

---

## 4. データ設計

### 4.1 データファイルの分離

| ファイル | 用途 | 更新方法 |
|---------|------|---------|
| `data/situations.json` | ユーザーの経験則・知見 | 手動管理（自動更新されない） |
| `data/ai_tactics.json` | AI生成の戦術 | GitHub Actionsで自動更新 |

### 4.2 経験則データの構造（situations.json）

```json
[
  {
    "id": "exp_001",
    "date": "2025-12-08",
    "tags": ["テスト", "効率化"],
    "title": "長文仕様書の論理矛盾チェック",
    "problem_context": "数万文字の仕様書変更差分を目視確認するコストが高い。",
    "recommended_ai": {
      "model": "Claude 3.5 Sonnet",
      "reason": "200kトークンのコンテキストと高い論理推論能力が必要なため。",
      "badge_color": "orange"
    },
    "prompt": "あなたは法務のプロです...",
    "source_news": null
  }
]
```

### 4.3 AI戦術データの構造（ai_tactics.json）

```json
[
  {
    "id": "20251208_150418_01",
    "date": "2025-12-08",
    "tags": ["エッジAI", "リアルタイム"],
    "title": "エッジAIでリアルタイム処理",
    "problem_context": "低レイテンシ・オフライン環境でのAI利用",
    "recommended_ai": {
      "model": "Mistral エッジモデル",
      "reason": "軽量・高速、デバイス内実行",
      "badge_color": "orange"
    },
    "prompt": "[デバイス]上で[タスク]をオフライン実行する軽量AIモデルの設計を提案してください。",
    "source_news": {
      "title": "Mistral AI、フラッグシップモデルとエッジデバイス向けモデルを発表",
      "url": "https://www.thetechbuzz.com/..."
    }
  }
]
```

### 4.4 データ項目の説明

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| id | 文字列 | ✓ | 一意識別子（経験則: `exp_001` / AI: `20251208_150418_01`） |
| date | 文字列 | ✓ | 作成日（形式: 2025-12-08） |
| tags | 配列 | ✓ | タグリスト（最低1個必要） |
| title | 文字列 | ✓ | 戦術のタイトル（最大100文字） |
| problem_context | 文字列 | ✓ | どんな問題を解決するのかの説明 |
| recommended_ai | オブジェクト | ✓ | 推奨AIの情報 |
| recommended_ai.model | 文字列 | ✓ | 推奨するAIモデル名 |
| recommended_ai.reason | 文字列 | ✓ | なぜこのモデルを推奨するのかの理由 |
| recommended_ai.badge_color | 文字列 | - | バッジの色（orange/blue/green） |
| prompt | 文字列 | ✓ | AIへのプロンプトテンプレート |
| source_news | オブジェクト/null | - | 元になったニュースの情報（経験則はnull） |
| source_news.title | 文字列 | - | ニュースのタイトル |
| source_news.url | 文字列 | - | ニュースのURL |

### 4.5 ID形式

| タイプ | 形式 | 例 | 説明 |
|--------|------|-----|------|
| 経験則 | `exp_XXX` | `exp_001` | ユーザーが手動で付与 |
| AI生成 | `YYYYMMDD_HHMMSS_NN` | `20251208_150418_01` | タイムスタンプ + 連番（重複防止） |

---

## 5. 画面設計

### 5.1 ナレッジカードの見た目

```
┌─────────────────────────────────────────────────────────────┐
│ 🔥 NEW  🤖 AI  [2025-12-08]                                 │
│ ▼ エッジAIでリアルタイム処理                                   │
├─────────────────────────────────────────────────────────────┤
│ [エッジAI] [リアルタイム]  🚀 推奨: Mistral エッジモデル         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 💡 なぜこのモデルを推奨するのか？                              │
│ 軽量・高速、デバイス内実行                                     │
│                                                             │
│ シチュエーション:                                             │
│ 低レイテンシ・オフライン環境でのAI利用                          │
│                                                             │
│ [ソース: Mistral AI発表 ↗]                                  │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ✨ プロンプト発行                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 画面全体のレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ 🎯 AI司令塔ナレッジ                                           │
│ 世界中のAIトレンドを自動収集 → 実務に使える戦術に変換            │
├─────────────────────────────────────────────────────────────┤
│ [🔍 キーワード検索        ] [📂 ソース ▼] [🏷️ タグ ▼]        │
│                            すべて                            │
│                            ✍️ 経験則のみ                     │
│                            🤖 AI提案のみ                     │
├─────────────────────────────────────────────────────────────┤
│ ▶ ⚙️ プロンプト変数を設定（折りたたみ）                        │
│   ├ 使用技術: [Python    ]                                  │
│   └ ターゲット: [上司     ]                                  │
├─────────────────────────────────────────────────────────────┤
│ 📚 15 件のナレッジ（✍️ 経験: 10件 / 🤖 AI: 5件）              │
│                                                             │
│ 🔥 NEW 🤖 [2025-12-08] ▼ エッジAIでリアルタイム処理...        │
│ 🔥 NEW 🤖 [2025-12-08] ▶ Gemini 3で開発効率最大化...         │
│ ✍️ [2025-12-05] ▶ 長文仕様書の論理矛盾チェック...              │
│ ...                                                         │
├─────────────────────────────────────────────────────────────┤
│     AI司令塔ナレッジ - 毎日自動で進化するナレッジベース            │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. API設計

### 6.1 Google Gemini API（ニュース収集用）

#### 使用ライブラリ
```python
from google import genai
from google.genai import types
```

#### リクエストの例（collector.py）
```python
client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

# Google Search Groundingを有効化
grounding_tool = types.Tool(
    google_search=types.GoogleSearch()
)

config = types.GenerateContentConfig(
    tools=[grounding_tool],
    temperature=0.3  # 低めにして事実重視
)

response = client.models.generate_content(
    model="gemini-2.5-flash-lite",
    contents=[prompt],
    config=config
)
```

#### プロンプト例
```
【出力形式】厳密に以下の形式で出力してください:
- [ニュースのタイトル](実際のURL): 要約（50字以内）

例:
- [Claude 3.5 Sonnetがリリース](https://anthropic.com/news/claude-3-5): 推論能力が大幅に向上
```

### 6.2 Google Gemini API（戦術分析用）

#### リクエストの例（analyst.py）
```python
response = client.models.generate_content(
    model='gemini-2.5-flash',
    contents=[prompt_text],
    config=types.GenerateContentConfig(
        temperature=0.3
    )
)
```

#### レスポンスの形式（JSON）
```json
{
  "title": "戦術タイトル",
  "problem_context": "解決する課題",
  "recommended_ai": {
    "model": "推奨AIモデル名",
    "reason": "推奨理由",
    "badge_color": "orange"
  },
  "prompt": "使えるプロンプト",
  "tags": ["タグ1", "タグ2"]
}
```

---

## 7. 自動化の仕組み

### 7.1 GitHub Actionsの設定（daily_intel.yml）

#### 実行スケジュール
```yaml
on:
  schedule:
    - cron: '0 21 * * *'  # 日本時間 06:00 (UTC 21:00)
  workflow_dispatch:  # 手動実行も可能
```

#### 権限設定
```yaml
permissions:
  contents: write  # リポジトリへの書き込み権限
```

#### ジョブの流れ
```
1. リポジトリをチェックアウト
2. Python 3.11環境をセットアップ
3. ライブラリをインストール（google-genai, python-dotenv, requests）
4. collector.py 実行 → news_raw.json 生成
5. analyst.py 実行 → new_tactics.json 生成
6. merge_tactics.py 実行 → ai_tactics.json 更新
7. 変更があればコミット＆プッシュ
```

### 7.2 必要なGitHub Secrets

| シークレット名 | 説明 |
|--------------|------|
| `GEMINI_API_KEY` | Google Gemini APIキー |

### 7.3 リポジトリ設定

**Settings → Actions → General → Workflow permissions**
- ✅ Read and write permissions（必須）

---

## 8. エラー処理

### 8.1 ニュース収集のエラー処理（collector.py）

| エラーの種類 | どう対処するか |
|------------|--------------|
| API接続エラー | 3回までリトライ（指数バックオフ）、失敗したらログに記録 |
| レスポンス解析エラー | 複数のパースパターンで試行、フォールバックあり |
| 認証エラー | ログに記録、終了コード1で終了 |

### 8.2 戦術分析のエラー処理（analyst.py）

| エラーの種類 | どう対処するか |
|------------|--------------|
| LLM API失敗 | 3回までリトライ、失敗したニュースはスキップ |
| JSON形式がおかしい | `fix_truncated_json()`で修復を試行 |
| 有効なニュースなし | 0件として正常終了（エラーではない） |

### 8.3 画面のエラー処理（app.py）

| エラーの種類 | どう対処するか |
|------------|--------------|
| JSON読み込み失敗 | 警告メッセージを表示、空リストで続ける |
| 検索結果が0件 | 情報メッセージを表示 |

---

## 9. セキュリティ

### 9.1 APIキーの管理

- **GitHub Secrets**: `GEMINI_API_KEY`
- **ローカル開発**: `.env`ファイル（`.gitignore`に追加済み）

### 9.2 アクセス制御

- GitHub Actionsの実行は`main`ブランチのみ
- コミットは自動生成ユーザー（`AI Staff Officer`）で実行

---

## 10. パフォーマンス要件

### 10.1 レスポンス時間の目標

| 操作 | 目標値 |
|------|--------|
| ページ読み込み | 2秒以内 |
| 検索・フィルタリング | 100ミリ秒以内 |
| プロンプト生成 | 50ミリ秒以内 |

### 10.2 データ量の制限

| 項目 | 制限 |
|------|------|
| AI戦術件数 | 最大500件 |
| 経験則件数 | 制限なし（手動管理） |
| 1日の新規追加 | 最大5件（ニュース収集数） |

### 10.3 キャッシュ設定

```python
@st.cache_data(ttl=300)  # 5分ごとにキャッシュを更新
def load_knowledge_base():
    ...
```

---

## 11. デプロイ方法

### 11.1 ローカル開発環境のセットアップ

```bash
# リポジトリをクローン
git clone https://github.com/Moto2ne/ai-code.git
cd ai-code

# 仮想環境を作成
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 必要なライブラリをインストール
pip install -r requirements.txt

# 環境変数を設定
cp .env.example .env
# .envファイルを編集してGEMINI_API_KEYを設定

# アプリを起動
streamlit run app.py
```

### 11.2 本番環境へのデプロイ（Streamlit Cloud）

1. GitHubリポジトリにプッシュ
2. [Streamlit Cloud](https://share.streamlit.io/)でリポジトリを接続
3. Secrets設定:
   - `GEMINI_API_KEY`（必要な場合）
4. デプロイ完了

### 11.3 手動でニュース収集・戦術生成を実行

```bash
# ニュース収集
python scripts/collector.py

# 戦術分析
python scripts/analyst.py

# マージ
python scripts/merge_tactics.py

# コミット＆プッシュ
git add data/ai_tactics.json
git commit -m "AI戦術を追加"
git push
```

---

## 12. 運用・保守

### 12.1 監視項目

| 項目 | 監視方法 |
|------|---------|
| GitHub Actionsの実行状況 | GitHub → Actions タブで確認 |
| 新規AI戦術の追加 | `data/ai_tactics.json`のコミット履歴を確認 |
| APIエラー | GitHub Actionsのログを確認 |

### 12.2 手動実行

GitHub → Actions → 「毎日のAIニュース収集＆戦術生成」→ Run workflow

---

## 13. 今後の拡張案

| 優先度 | 機能 | 説明 |
|--------|------|------|
| ✅ 完了 | データ分離 | 経験則とAI生成を別ファイルに分離 |
| ✅ 完了 | 自動収集・分析 | GitHub Actionsによる自動化 |
| ✅ 完了 | ソースフィルター | 経験則/AI提案の切り替え |
| 中 | ナレッジ追加UI | 管理者がWeb画面からナレッジを追加できる |
| 中 | お気に入り機能 | よく使うナレッジをブックマークできる |
| 低 | 利用統計 | 検索・発行の履歴を記録・可視化する |
| 低 | エクスポート | プロンプトをファイル出力できる |

---

## 14. 改訂履歴

| 版 | 日付 | 内容 |
|----|------|------|
| 1.0 | 2025/12/08 | 初版作成 |
| 2.0 | 2025/12/08 | 自動更新機能を追加 |
| 3.0 | 2025/12/08 | 現状の実装に合わせて全面改訂<br>- データ分離（situations.json / ai_tactics.json）<br>- タイムスタンプID形式<br>- Gemini 2.5モデル対応<br>- ソースフィルター機能<br>- キャッシュTTL設定 |

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| 戦術 | エンジニアがすぐに使えるAIプロンプトとその文脈 |
| 経験則 | ユーザーが手動で追加した知見（✍️マーク） |
| AI提案 | 自動収集されたニュースから生成された戦術（🤖マーク） |
| Collector | ニュース収集スクリプト（collector.py） |
| Analyst | 戦術分析スクリプト（analyst.py） |
| Google Search Grounding | Gemini APIのリアルタイムWeb検索機能 |

### B. 参考資料

- [Google Gemini API Documentation](https://ai.google.dev/gemini-api/docs)
- [Google GenAI Python SDK](https://pypi.org/project/google-genai/)
- [Streamlit Documentation](https://docs.streamlit.io/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Streamlit Cloud](https://share.streamlit.io/)
